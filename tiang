#!/usr/bin/env bash

function tiang::trace {
	[ "$TIANG_TRACE" == "true" ] && echo -e "\e[0;30m${FUNCNAME[1]}: ${BASH_LINENO[0]}: $*\e[0m"
}

function tiang::error {
	echo -e "\e[0;31mtiang: $*\e[0m" 1>&2
	exit 1
}

function tiang::succ {
	echo -e "\e[0;32m$*\e[0m"
}

tiangOptionsUsage="""
    -? --help                   Print usage
    --trace                     Enable tracing logs
    -j --jobs     [JOBS]        Set parallel execution count (default: 4)
    --tty                       Force SSH to allocate a TTY on remote host
"""

tiangCommandsUsage="""
  TARGETING:
    -a --target   [NAME] [ADDR] Add a new target with given ssh address
    -n --remove   [NAME]        Remove a target from target list
    -y --include  [NAME]        Add a target to target list
    -o --only     [NAME]        Set target list to the given target
    --none                      Clear target list

    -f --filter   [FILTER]      Filter targets with jq filters
    -w --with     [TAG]         Filter targets with tag
    -w! --with!   [TAG]         Filter targets with inverted tag
    -g --grep     [NAME]        Filter targets with name literal
    -g! --grep!   [NAME]        Filter targets with no name literal
    -r --regex    [REGEX]       Filter targets with name regex
    -r! --regex!  [REGEX]       Filter targets with no name regex

  EXECUTING:
    -p --print                  Print all selected targets
    -pa --print-all             Print all available targets
    -k --confirm                Print selected targets and ask for confirm

    -c --command  [COMMAND]     Run command on targets
    -t --copy     [FILE] [DEST] Copy a file to targets
    -s --script   [FILE]        Copy a script to targets and run it
"""

function tiang::usage {
	tiang::trace "print usage"
	cat 1>&2 <<XXX
usage: $0 [OPTIONS] <COMMANDS>

OPTIONS:
$tiangOptionsUsage
COMMANDS:
$tiangCommandsUsage
XXX
}

declare -a tiangTargets tiangAllTargets
declare -A tiangTargetSSH tiangTargetData tiangTargetTags
function tiang::target {
	[ $# -lt 2 ] || [ $# -gt 3 ] && tiang::error "tiang::target <NAME> <SSH URI> [DATA]"
	tiangAllTargets+=("$1")
	tiangTargetSSH[$1]="$2"
	[ $# -gt 2 ] && tiangTargetData[$1]="$3"
	tiangTargetTags[$1]=""
}

function tiang::tag {
	[ $# -ne 2 ] && tiang::error "tiang::tag <NAME> <TAG>"
	tiangTargetTags[$1]="$(printf '%s;%s' "${tiangTargetTags[$1]}" "$2")"
}

declare -a tiangCommandHandlers
function tiang::defineCommand {
	[ $# -ne 1 ] && tiang::error "tiang::defineCommand <HANDLER>"
	tiangCommandHandlers+=("$1")
}

function tiang::loadProfiles {
	declare -a tiangProfileFiles
	[[ "$TIANG_PROFILE" != "" ]] && tiangProfileFiles+=("$TIANG_PROFILE")
	[[ -f ".tianguan.sh" ]] && tiangProfileFiles+=(".tianguan.sh")
	[[ -f ".tianguan.bash" ]] && tiangProfileFiles+=(".tianguan.bash")
	[[ -f ".tianguan.profile.sh" ]] && tiangProfileFiles+=(".tianguan.profile.sh")
	[[ -f ".tianguan/profile" ]] && tiangProfileFiles+=(".tianguan/profile")
	[[ -f ".tianguan/profile.sh" ]] && tiangProfileFiles+=(".tianguan/profile.sh")
	[[ -f ".tianguan/profile.bash" ]] && tiangProfileFiles+=(".tianguan/profile.bash")

	local tiangProfile
	[ ${#tiangProfileFiles[@]} -eq 0 ] && tiang::error "no profile scripts found"
	for tiangProfile in "${tiangProfileFiles[@]}"; do
		tiang::trace "sourcing $tiangProfile"
		# shellcheck source=/dev/null
		source "$tiangProfile"
	done

	[ ${#tiangAllTargets[@]} -eq 0 ] && tiang::error "no targets are defined"
}

function tiang::makeSectionHeader {
	[ $# -ne 1 ] && tiang::error "tiang::makeSectionHeader <TITLE>"
	local tiangTitleLen=${#1}
	local tiangTitle=""
	for ((i = 0; i < (80 - tiangTitleLen - 2) / 2; i++)); do tiangTitle+='\u2501'; done
	tiangTitle+=" $1 "
	for ((i = 0; i < (80 - tiangTitleLen - 2) / 2; i++)); do tiangTitle+='\u2501'; done
	echo -ne "\e[1;32m$tiangTitle\e[0m"
}

declare tiangRunParallel=${TIANG_PARALLEL:-4} tiangParaCount=0
declare -a tiangParaIds
function tiang::runParallelOnTargets {
	[ $# -lt 1 ] && tiang::error "tiang::runParallelOnTargets <FUNC> [ARGS]..."
	tiang::trace "parallel execution: $*"
	local tiangTgt tiangFunc=$1 tiangTmp
	shift
	tiangTmp=/tmp/tiang.parallel.$(head -c64 /dev/urandom | md5sum | head -c10)

	for tiangTgt in "${tiangTargets[@]}"; do
		if ((tiangParaCount >= tiangRunParallel)); then
			tiang::waitParallelExecution
		fi
		((tiangParaCount++))
		{
			if [ "${TIANG_OUTPUT_SYNC:-true}" == "true" ]; then
				local tiangOut tiangStatus tiangTitle=$tiangTgt
				tiangOut=$($tiangFunc "$tiangTgt" "$@" 2>&1)
				tiangStatus=$?
				((tiangStatus != 0)) && tiangTitle+=" ($tiangStatus)"
				echo -e "$(tiang::makeSectionHeader "$tiangTitle")\n$tiangOut" &>"$tiangTmp.$BASHPID"
			else
				$tiangFunc "$tiangTgt" "$@"
			fi
		} &
		tiangParaIds+=($!)
	done

	while ((tiangParaCount > 0)); do tiang::waitParallelExecution; done
}
function tiang::waitParallelExecution {
	local tiangRetId
	# shellcheck disable=SC2068
	wait -f -n -p tiangRetId ${tiangParaIds[@]}
	for i in "${!tiangParaIds[@]}"; do [ "${tiangParaIds[$i]}" == "$tiangRetId" ] && {
		unset "tiangParaIds[$i]"
		break
	}; done
	cat "$tiangTmp.$tiangRetId"
	rm "$tiangTmp.$tiangRetId"
	((tiangParaCount--))
}

function tiang::runSSH {
	[ $# -lt 2 ] && tiang::error "tiang::runSSH <TARGET> <COMMAND>..."
	local tiangTgt=$1
	shift
	# shellcheck disable=SC2086,SC2068
	${SSH:-ssh} ${SSH_FLAGS} ${tiangTargetSSH[$tiangTgt]} "$@"
}

SCP_FLAGS+=-r
function tiang::runSCP {
	[ $# -lt 3 ] && tiang::error "tiang::runSCP <TARGET> <SOURCE> <DEST>"
	# shellcheck disable=SC2086
	${SCP:-scp} ${SCP_FLAGS} "$2" "${tiangTargetSSH[$1]/#ssh\:\/\//scp\:\/\/}/$3"
}

function tiang::cmd::target {
	[ $# -lt 3 ] && tiang::error "2 parameters are required for --target"
	tiang::target "$2" "$3"
	tiangTargets+=("$2")
}

function tiang::cmd::remove {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --remove"
	tiangTargets=("${tiangTargets[@]/$2/}")
}

function tiang::cmd::include {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --include"
	[[ " ${tiangAllTargets[*]} " = *" $2 "* ]] || tiang::error "target $2 is never defined. use -a instead"
	tiangTargets+=("$2")
}

function tiang::cmd::only {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --only"
	[[ " ${tiangAllTargets[*]} " = *" $2 "* ]] || tiang::error "target $2 is never defined. use -a instead"
	tiangTargets=("$2")
}

function tiang::cmd::none {
	tiangTargets=()
}

function tiang::cmd::filter {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --filter"
	local tiangTgt tiangTgtData tiangTgtJq
	local -a tiangTgts
	for tiangTgt in "${tiangTargets[@]}"; do
		tiangTgtData=${tiangTargetData[$tiangTgt]}
		[ "$tiangTgtData" == "" ] && continue
		tiangTgtJq=$(jq -c "$2" <<<"$tiangTgtData")
		{ [ "$tiangTgtJq" == "null" ] || [ "$tiangTgtJq" == "false" ]; } && continue
		tiangTgts+=("$tiangTgt")
	done
	tiangTargets=("${tiangTgts[@]}")
}

function tiang::cmd::with {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --with"
	local tiangTgt tiangTgtTags tiangGrepInverted=""
	local -a tiangTgts tiangGrepFlags=(-Fxqz)
	{ [ "$1" == '-w!' ] || [ "$1" == '--with!' ]; } && tiangGrepInverted="true"
	for tiangTgt in "${tiangTargets[@]}"; do
		tiangTgtTags=${tiangTargetTags[$tiangTgt]}
		[ "$tiangTgtTags" == "" ] && [ -n "$tiangGrepInverted" ] && {
			tiangTgts+=("$tiangTgt")
			continue
		}
		if tr ';' '\0' <<<"$tiangTgtTags" | grep "${tiangGrepFlags[@]}" -- "$2"; then
			[ -z "$tiangGrepInverted" ] && tiangTgts+=("$tiangTgt")
		else
			[ -n "$tiangGrepInverted" ] && tiangTgts+=("$tiangTgt")
		fi
	done
	tiangTargets=("${tiangTgts[@]}")
}

function tiang::cmd::grep {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --grep"
	local tiangTgts
	local -a tiangGrepFlags=(-i)
	{ [ "$1" == '-g' ] || [ "$1" == '--grep' ]; } && tiangGrepFlags+=(-F)
	{ [ "$1" == '-g!' ] || [ "$1" == '--grep!' ]; } && tiangGrepFlags+=(-F -v)
	{ [ "$1" == '-r' ] || [ "$1" == '--regex' ]; } && tiangGrepFlags+=(-E)
	{ [ "$1" == '-r!' ] || [ "$1" == '--regex!' ]; } && tiangGrepFlags+=(-E -v)
	# shellcheck disable=SC2068
	tiangTgts=$( (
		local IFS=$'\n'
		echo "${tiangTargets[*]}"
	) | grep ${tiangGrepFlags[@]} "$2")
	readarray -d $'\n' -t tiangTargets <<<"$tiangTgts"
}

function tiang::cmd::print {
	local IFS=$'\n'
	echo "${tiangTargets[*]}"
}

function tiang::cmd::printAll {
	local IFS=$'\n'
	echo "${tiangAllTargets[*]}"
}

function tiang::cmd::confirm {
	tiang::succ "Targets (${#tiangAllTargets[*]}):"
	local tiangTgt tiangChoice="."
	for tiangTgt in "${tiangTargets[@]}"; do echo "  - $tiangTgt"; done
	while [ "$tiangChoice" != "" ] && [ "$tiangChoice" != "y" ] && [ "$tiangChoice" != "n" ]; do
		printf "\x1b[38;5;22m(y/n): \e[0m"
		read -p "" -r tiangChoice
	done
	[ "$tiangChoice" == "n" ] && exit 1
}

function tiang::cmd::command {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --command"
	tiang::runParallelOnTargets tiang::runSSH "$2"
}

function tiang::cmd::copy {
	[ $# -lt 3 ] && tiang::error "2 parameters are required for --copy"
	tiang::runParallelOnTargets tiang::runSCP "$2" "$3"
}

function tiang::runScript {
	local tiangTmp
	tiangTmp=/tmp/tiang.script.$(head -c64 /dev/urandom | md5sum | head -c10)
	{
		local SCP_FLAGS
		SCP_FLAGS+=-q
		tiang::runSCP "$1" "$2" "$tiangTmp"
	}
	tiang::runSSH "$1" "chmod +x $tiangTmp; $tiangTmp; rm -f $tiangTmp"
}

function tiang::cmd::script {
	[ $# -lt 2 ] && tiang::error "1 parameter is required for --script"
	tiang::runParallelOnTargets tiang::runScript "$2"
}

declare tiangHandledParams
function tiang::main {
	tiang::loadProfiles
	[ $# -eq 0 ] && tiang::usage && exit

	tiangTargets=("${tiangAllTargets[@]}")

	while [ $# -ne 0 ]; do
		case $1 in
		-\? | --help)
			tiang::usage
			exit
			;;
		--trace)
			TIANG_TRACE=true
			shift
			;;
		-j | --jobs)
			tiangRunParallel=$2
			shift 2
			;;
		--tty)
			SSH_FLAGS+="-t -t"
			shift
			;;
		-a | --target)
			tiang::cmd::target "$@"
			shift 3
			;;
		-n | --remove)
			tiang::cmd::remove "$@"
			shift 2
			;;
		-y | --include)
			tiang::cmd::include "$@"
			shift 2
			;;
		-o | --only)
			tiang::cmd::only "$@"
			shift 2
			;;
		--none)
			tiang::cmd::none "$@"
			shift 1
			;;
		-f | --filter)
			tiang::cmd::filter "$@"
			shift 2
			;;
		-w | --with | -w! | --with!)
			tiang::cmd::with "$@"
			shift 2
			;;
		-g | --grep | -g! | --grep! | -r | --regex | -r! | --regex!)
			tiang::cmd::grep "$@"
			shift 2
			;;
		-p | --print)
			tiang::cmd::print "$@"
			shift 1
			;;
		-pa | --print-all)
			tiang::cmd::printAll "$@"
			shift 1
			;;
		-k | --confirm)
			tiang::cmd::confirm "$@"
			shift 1
			;;
		-c | --command)
			tiang::cmd::command "$@"
			shift 2
			;;
		-t | --copy)
			tiang::cmd::copy "$@"
			shift 3
			;;
		-s | --script)
			tiang::cmd::script "$@"
			shift 2
			;;
		*)
			local tiangCommandHandler tiangPrevParames=$#
			for tiangCommandHandler in "${tiangCommandHandlers[@]}"; do
				if "$tiangCommandHandler" "$@"; then
					if [[ "${tiangHandledParams:-}" -eq "" ]]; then
						tiang::error "custom command handler returned successfully but without tiangHandledParams"
					fi
					shift "$tiangHandledParams"
					tiangHandledParams=
				else
					exit $?
				fi
				[ $# -ne $tiangPrevParames ] && break
			done
			[ $# -eq $tiangPrevParames ] && tiang::error "unknown option: $1"
			;;
		esac
	done
}

tiang::main "$@"
